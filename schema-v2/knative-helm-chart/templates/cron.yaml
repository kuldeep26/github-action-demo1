apiVersion: batch/v1
kind: CronJob
metadata:
  name: ecr-secret-refresh
  namespace: hello-world
spec:
  schedule: "*/5 * * * *"  # Every 5 minutes
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: ecr-secret-refresh
            image: amazon/aws-cli
            args:
              - /bin/sh
              - -c
              - |
                aws ecr get-login-password --region us-east-1 | \
                kubectl create secret docker-registry ecr-registry-secret \
                  --docker-server=637423660652.dkr.ecr.us-east-1.amazonaws.com \
                  --docker-username=AWS \
                  --docker-password="$(cat)" \
                  --namespace hello-world --dry-run=client -o yaml | \
                kubectl apply -f -
          restartPolicy: OnFailure
